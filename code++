#include <SoftwareSerial.h> 
// adding Bluetooth hc - 05 connection
SoftwareSerial BT(2, 3); // RX, TX
// connecting Motor Driver L298N 
#define enA 10 
#define in1 9 
#define in2 8 
#define in3 7
#define in4 6 
#define enB 5
// connect sensors 
#define L_S A0 
#define R_S A1 
#define echo A2 
#define trigger A3 
#define servo A5 
int distance_L, distance_F, distance_R; 
int Set = 15; String command = ""; 
// + mode  
bool AUTO_MODE = true; 
// adding servo motor 
void servoPulse(int pin, int angle){ 
int pwm = (angle * 11) + 500; 
digitalWrite(pin, HIGH); 
delayMicroseconds(pwm); 
digitalWrite(pin, LOW); 
delay(30); 
}
// adding obstacle avoiding  
void compareDistance(){ 
if(distance_L > distance_R){ 
turnLeft(); 
delay(500); 
forward(); 
delay(600); 
turnRight(); 
delay(500); 
forward(); 
delay(600); 
turnRight();
delay(400);
}
else { 
turnRight();
delay(500);
forward();
delay(600); 
turnLeft(); 
delay(500);
forward(); 
delay(600); 
turnLeft(); 
(400); 
} 
} 
void Check_side(){ 
Stop(); 
delay(100); 
for(int a=70; a<=140; a+=5)
servoPulse(servo, a); 
delay(300); 
distance_R = Ultrasonic_read(); 
for(int a=140; a>=0; a-=5) 
servoPulse(servo, a);
delay(300); 
distance_L = Ultrasonic_read(); 
for(int a=0; a<=70; a+=5) 
servoPulse(servo, a); 
compareDistance(); 
}
// added Bluetooth command reading and manual control processing
void readBluetooth(){
  if(BT.available()){
    char c = BT.read();


    // Fix:OR
    if(c == '\n' || c == '\r'){
      processCommand(command);
      command = "";
    } else {
      command += c;
    }
  }
}


void processCommand(String cmd){
  cmd.toLowerCase();


  if(cmd == "auto"){
    AUTO_MODE = true;
    BT.println("AUTO mode enabled");
  }
  else if(cmd == "manual"){
    AUTO_MODE = false;
    Stop();
    BT.println("MANUAL mode enabled");
  }
  else if(!AUTO_MODE){
    if(cmd == "forward" || cmd == "f") forward();
    else if(cmd == "back" || cmd == "b") back();
    else if(cmd == "left" || cmd == "l") turnLeft();
    else if(cmd == "right" || cmd == "r") turnRight();
    else if(cmd == "stop" || cmd == "s") Stop();
  }
}
// added setup routine for initializing sensors, motors, servo and communication
void setup(){
  Serial.begin(9600);
  BT.begin(9600);


  pinMode(R_S, INPUT);
  pinMode(L_S, INPUT);
  pinMode(echo, INPUT);
  pinMode(trigger, OUTPUT);


  pinMode(enA, OUTPUT);
  pinMode(enB, OUTPUT);
  pinMode(in1, OUTPUT);
  pinMode(in2, OUTPUT);
  pinMode(in3, OUTPUT);
  pinMode(in4, OUTPUT);
  pinMode(servo, OUTPUT);


  analogWrite(enA, 200);
  analogWrite(enB, 200);


  for(int a=70; a<=140; a+=5) servoPulse(servo, a);
  for(int a=140; a>=0; a-=5) servoPulse(servo, a);
  for(int a=0; a<=70; a+=5) servoPulse(servo, a);
}
// added final loop logic for auto navigation and line following
void loop(){
  readBluetooth();


  if(!AUTO_MODE) return;  // MANUAL mode


  distance_F = Ultrasonic_read();


  if(digitalRead(R_S)==0 && digitalRead(L_S)==0){
    if(distance_F > Set) forward();
    else Check_side();
  }
  else if(digitalRead(R_S)==1 && digitalRead(L_S)==0){
    turnRight();
  }
  else if(digitalRead(R_S)==0 && digitalRead(L_S)==1){
    turnLeft();
  }


  delay(10);
}

